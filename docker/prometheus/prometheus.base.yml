global:
  scrape_interval: __SCRAPE_INTERVAL__
  evaluation_interval: __SCRAPE_INTERVAL__

scrape_configs:
  # Static scrape for known services (fallback)
  - job_name: 'gatrix-static'
    metrics_path: /metrics
    static_configs:
      - targets:
          - backend__SERVICE_SUFFIX__:5000
          - event-lens__SERVICE_SUFFIX__:5200
          - chat-server__SERVICE_SUFFIX__:5100
        labels:
          service: chat

  # Discovered services via Backend HTTP-SD
  - job_name: 'gatrix-discovered'
    metrics_path: /metrics
    scheme: http
    http_sd_configs:
      - url: http://backend__SERVICE_SUFFIX__:5000/api/v1/public/monitoring/prometheus/targets
        refresh_interval: 30s
    relabel_configs:
      # Respect metrics_path from target labels if provided
      - source_labels: [metrics_path]
        target_label: __metrics_path__

  # MySQL Exporter
  - job_name: 'mysql'
    static_configs:
      - targets: ['mysql-exporter:9104']
        labels:
          service: mysql
          instance: mysql

  # Redis Exporter
  - job_name: 'redis'
    static_configs:
      - targets: ['redis-exporter:9121']
        labels:
          service: redis
          instance: redis

  # ClickHouse Metrics (native Prometheus endpoint)
  - job_name: 'clickhouse'
    static_configs:
      - targets: ['clickhouse:8123']
        labels:
          service: clickhouse
          instance: clickhouse
    metrics_path: '/metrics'

  # etcd Metrics
  - job_name: 'etcd'
    static_configs:
      - targets: ['etcd:2379']
        labels:
          service: etcd
          instance: etcd
          hostname: etcd
          ip: etcd

  # Prometheus Self-Monitoring
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
        labels:
          service: prometheus
          instance: prometheus

  # Loki Metrics
  - job_name: 'loki'
    static_configs:
      - targets: ['loki:3100']
        labels:
          service: loki
          instance: loki
          hostname: loki
          ip: loki

