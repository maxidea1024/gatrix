# Development Dockerfile for Edge server
FROM node:22-alpine

# Install dependencies
RUN apk add --no-cache libc6-compat

WORKDIR /app

# Use Tencent npm mirror for faster downloads in China
RUN yarn config set registry http://mirrors.cloud.tencent.com/npm/

# Copy package files
COPY package.json yarn.lock* ./
COPY packages/edge/package.json ./packages/edge/
COPY packages/shared/package.json ./packages/shared/
COPY packages/sdks/server-sdk/package.json ./packages/sdks/server-sdk/

# Skip Cypress binary download - not needed in production Docker image
ENV CYPRESS_INSTALL_BINARY=0

# Install dependencies
RUN yarn install --frozen-lockfile --network-timeout 600000

# Install SWC native binding for Alpine Linux (musl)
RUN yarn add -W --dev @swc/core-linux-x64-musl --ignore-scripts

# Copy source code
COPY packages/edge ./packages/edge
COPY packages/shared ./packages/shared
COPY packages/sdks/server-sdk ./packages/sdks/server-sdk
COPY tsconfig.json ./

# Build shared
RUN cd packages/shared && yarn build

# Build server-sdk
RUN cd packages/sdks/server-sdk && yarn build

WORKDIR /app/packages/edge

# Main API port
EXPOSE 1400
# Metrics port (internal only)
EXPOSE 9400

ENV NODE_ENV=development
ENV EDGE_PORT=1400
ENV EDGE_METRICS_PORT=9400

# Run in development mode with hot reload
CMD ["yarn", "dev"]

