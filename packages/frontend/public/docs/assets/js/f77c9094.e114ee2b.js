"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[168],{2465(e,n,r){r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>t,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"features/monitoring","title":"Monitoring (Prometheus + Grafana)","description":"This guide explains how Gatrix integrates Prometheus and Grafana for monitoring in both development and production.","source":"@site/docs/features/monitoring.md","sourceDirName":"features","slug":"/features/monitoring","permalink":"/docs/features/monitoring","draft":false,"unlisted":false,"editUrl":"https://github.com/your-org/gatrix/tree/main/docs/docs/features/monitoring.md","tags":[],"version":"current","sidebarPosition":9,"frontMatter":{"sidebar_position":9}}');var i=r(4848),l=r(8453);const o={sidebar_position:9},t="Monitoring (Prometheus + Grafana)",d={},c=[{value:"Overview",id:"overview",level:2},{value:"Architecture",id:"architecture",level:2},{value:"Ports",id:"ports",level:2},{value:"Environment Variables",id:"environment-variables",level:2},{value:"Docker Compose",id:"docker-compose",level:2},{value:"Backend HTTP-SD Endpoint",id:"backend-http-sd-endpoint",level:2},{value:"Enabling Metrics Per Service",id:"enabling-metrics-per-service",level:2},{value:"SDK Metrics Server",id:"sdk-metrics-server",level:2},{value:"Quick Setup",id:"quick-setup",level:3},{value:"Default Labels",id:"default-labels",level:3},{value:"Service Discovery Integration",id:"service-discovery-integration",level:3},{value:"Custom Metrics",id:"custom-metrics",level:3},{value:"Admin Panel Integration",id:"admin-panel-integration",level:2},{value:"How to Run (Local/Docker)",id:"how-to-run-localdocker",level:2},{value:"Custom Metrics Guide (Preview)",id:"custom-metrics-guide-preview",level:2},{value:"Security Notes",id:"security-notes",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Prometheus Targets",id:"prometheus-targets",level:3},{value:"Host-Based Game Server Metrics (Docker Environment)",id:"host-based-game-server-metrics-docker-environment",level:3},{value:"Grafana Logs Dashboard Not Showing All Log Levels",id:"grafana-logs-dashboard-not-showing-all-log-levels",level:3},{value:"Internationalization",id:"internationalization",level:2},{value:"Loki Direct Log Push (SDK)",id:"loki-direct-log-push-sdk",level:2},{value:"How it Works",id:"how-it-works",level:3},{value:"Configuration",id:"configuration",level:3},{value:"Environment Variables",id:"environment-variables-1",level:3},{value:"Migration from Promtail",id:"migration-from-promtail",level:3}];function a(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,l.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"monitoring-prometheus--grafana",children:"Monitoring (Prometheus + Grafana)"})}),"\n",(0,i.jsx)(n.p,{children:"This guide explains how Gatrix integrates Prometheus and Grafana for monitoring in both development and production."}),"\n",(0,i.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Prometheus scrapes metrics from services discovered via Backend HTTP-SD endpoint using existing etcd/Redis service discovery."}),"\n",(0,i.jsx)(n.li,{children:"Grafana is pre-provisioned to use Prometheus as the default data source and ships with a starter dashboard."}),"\n",(0,i.jsx)(n.li,{children:"Admin Panel has a Grafana shortcut at the bottom of the sidebar (opens in a new tab)."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"architecture",children:"Architecture"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Prometheus","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Runs in Docker."}),"\n",(0,i.jsx)(n.li,{children:"Retention and scrape interval are configurable via environment variables."}),"\n",(0,i.jsxs)(n.li,{children:["Targets are discovered dynamically from Backend: ",(0,i.jsx)(n.code,{children:"/api/v1/public/monitoring/prometheus/targets"}),"."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Backend HTTP Service Discovery","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Uses serviceDiscoveryService.getServices() to fetch active services from etcd/Redis."}),"\n",(0,i.jsxs)(n.li,{children:["Exposes Prometheus HTTP-SD JSON with each service's ",(0,i.jsx)(n.code,{children:"internalAddress"})," and a suitable ",(0,i.jsx)(n.code,{children:"metrics_path"}),"."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Grafana","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Runs in Docker."}),"\n",(0,i.jsxs)(n.li,{children:["Auto-provisioned with Prometheus datasource (",(0,i.jsx)(n.a,{href:"http://prometheus:9090",children:"http://prometheus:9090"}),') and a sample "Gatrix Overview" dashboard.']}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"ports",children:"Ports"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Prometheus: host 49090 -> container 9090"}),"\n",(0,i.jsx)(n.li,{children:"Grafana: host 44000 -> container 3000"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"You can override host ports via environment variables:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"PROMETHEUS_PORT"})," (default 49090)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"GRAFANA_PORT"})," (default 44000)"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"environment-variables",children:"Environment Variables"}),"\n",(0,i.jsx)(n.p,{children:"Prometheus (both dev/prod):"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"PROM_SCRAPE_INTERVAL"}),": default ",(0,i.jsx)(n.code,{children:"15s"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"PROM_RETENTION_TIME"}),": default ",(0,i.jsx)(n.code,{children:"14d"})]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Grafana (both dev/prod):"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"GRAFANA_ADMIN_USER"}),": default ",(0,i.jsx)(n.code,{children:"admin"})," (mapped to ",(0,i.jsx)(n.code,{children:"GF_SECURITY_ADMIN_USER"}),")"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"GRAFANA_ADMIN_PASSWORD"}),": default ",(0,i.jsx)(n.code,{children:"admin"})," (mapped to ",(0,i.jsx)(n.code,{children:"GF_SECURITY_ADMIN_PASSWORD"}),")"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"GF_USERS_ALLOW_SIGN_UP"}),": defaults to ",(0,i.jsx)(n.code,{children:"false"})]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Backend:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"PROMETHEUS_IN_DOCKER"}),": default ",(0,i.jsx)(n.code,{children:"true"}),". Set to ",(0,i.jsx)(n.code,{children:"false"})," if Prometheus runs outside Docker (e.g., on host machine or separate monitoring server)."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Frontend:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"VITE_GRAFANA_URL"}),": Optional. If set, the Admin Panel shortcut uses this URL; otherwise it defaults to ",(0,i.jsx)(n.code,{children:"http(s)://<host>:44000"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"docker-compose",children:"Docker Compose"}),"\n",(0,i.jsx)(n.p,{children:"Development:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Services added: ",(0,i.jsx)(n.code,{children:"prometheus"}),", ",(0,i.jsx)(n.code,{children:"grafana"})]}),"\n",(0,i.jsxs)(n.li,{children:["Persistent volumes: ",(0,i.jsx)(n.code,{children:"prometheus_dev_data"}),", ",(0,i.jsx)(n.code,{children:"grafana_dev_data"})]}),"\n",(0,i.jsxs)(n.li,{children:["Prometheus entrypoint performs env substitution and starts Prometheus with ",(0,i.jsx)(n.code,{children:"--web.enable-lifecycle"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Production:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Services added: ",(0,i.jsx)(n.code,{children:"prometheus"}),", ",(0,i.jsx)(n.code,{children:"grafana"})]}),"\n",(0,i.jsxs)(n.li,{children:["Persistent volumes: ",(0,i.jsx)(n.code,{children:"prometheus_data"}),", ",(0,i.jsx)(n.code,{children:"grafana_data"})]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Files:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"docker/prometheus/prometheus.base.yml"})," (template; interval injected by entrypoint)"]}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"docker/prometheus/entrypoint.sh"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"docker/grafana/provisioning/datasources/datasource.yml"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"docker/grafana/provisioning/dashboards/dashboards.yml"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"docker/grafana/dashboards/gatrix-overview.json"})}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"backend-http-sd-endpoint",children:"Backend HTTP-SD Endpoint"}),"\n",(0,i.jsxs)(n.p,{children:["Path: ",(0,i.jsx)(n.code,{children:"/api/v1/public/monitoring/prometheus/targets"})]}),"\n",(0,i.jsx)(n.p,{children:"Behavior:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Returns an array of target groups in Prometheus HTTP-SD format."}),"\n",(0,i.jsxs)(n.li,{children:["Uses each service's ",(0,i.jsx)(n.code,{children:"internalAddress"})," and determines a metrics port/path per service type (e.g., chat -> 9090 ",(0,i.jsx)(n.code,{children:"/metrics"}),")."]}),"\n",(0,i.jsxs)(n.li,{children:["Safe fallback: returns ",(0,i.jsx)(n.code,{children:"[]"})," on internal errors to avoid Prometheus failures."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"enabling-metrics-per-service",children:"Enabling Metrics Per Service"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Chat Server: Already integrated via ",(0,i.jsx)(n.code,{children:"prom-client"}),". Enable with ",(0,i.jsx)(n.code,{children:"MONITORING_ENABLED=true"}),", metrics served on ",(0,i.jsx)(n.code,{children:"METRICS_PORT=9090"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Backend & Event Lens: Planned to use ",(0,i.jsx)(n.code,{children:"prom-client"})," similarly to Chat Server.","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Add ",(0,i.jsx)(n.code,{children:"/metrics"})," endpoint guarded by ",(0,i.jsx)(n.code,{children:"MONITORING_ENABLED"}),"."]}),"\n",(0,i.jsx)(n.li,{children:"Expose default process metrics and HTTP request metrics."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Note: We will request permission before installing new dependencies (prom-client) in these packages."}),"\n",(0,i.jsx)(n.h2,{id:"sdk-metrics-server",children:"SDK Metrics Server"}),"\n",(0,i.jsx)(n.p,{children:"The Server SDK provides an independent metrics server for Prometheus scraping. All services using the SDK can expose metrics on a consistent port (default: 9337)."}),"\n",(0,i.jsx)(n.h3,{id:"quick-setup",children:"Quick Setup"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"import { GatrixServerSDK, createMetricsServer, getLogger } from '@gatrix/server-sdk';\n\nconst logger = getLogger('MY-SERVER');\n\n// Create SDK with required identification fields\nconst sdk = new GatrixServerSDK({\n  gatrixUrl: 'http://localhost:45000',\n  apiToken: 'your-api-token',\n  applicationName: 'my-game-server',\n  service: 'worldd', // Required: service name\n  group: 'kr-1', // Required: service group\n  environment: 'env_prod', // Required: environment\n  metrics: {\n    port: 9337, // Optional: default is 9337\n  },\n});\n\n// Create standalone metrics server\nconst metricsServer = createMetricsServer({\n  port: 9337,\n  applicationName: 'my-game-server',\n  service: 'worldd',\n  group: 'kr-1',\n  environment: 'env_prod',\n  logger,\n});\n\n// Start metrics server\nmetricsServer.start();\n"})}),"\n",(0,i.jsx)(n.h3,{id:"default-labels",children:"Default Labels"}),"\n",(0,i.jsx)(n.p,{children:"All SDK metrics automatically include these default labels:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"sdk"}),": ",(0,i.jsx)(n.code,{children:"gatrix-server-sdk"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"service"}),": Service name from config"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"group"}),": Service group from config"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"environment"}),": Environment from config"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"application"}),": Application name from config"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"These labels enable filtering and aggregation in Grafana dashboards."}),"\n",(0,i.jsx)(n.h3,{id:"service-discovery-integration",children:"Service Discovery Integration"}),"\n",(0,i.jsxs)(n.p,{children:["When registering a service, the SDK automatically reports the ",(0,i.jsx)(n.code,{children:"metricsApi"})," port:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"const result = await sdk.registerService({\n  labels: { service: 'worldd', group: 'kr-1' },\n  ports: {\n    game: 7777, // Named port: { serviceName: port }\n    web: 8080,\n    // metricsApi is automatically added from SDK config (default: 9337)\n  },\n  status: 'ready',\n});\n"})}),"\n",(0,i.jsx)(n.p,{children:"Prometheus can then discover and scrape metrics from all registered services via the Backend HTTP-SD endpoint."}),"\n",(0,i.jsx)(n.h3,{id:"custom-metrics",children:"Custom Metrics"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// Create custom metrics\nconst playersOnline = metricsServer.createGauge(\n  'players_online',\n  'Number of players currently online',\n  ['server_id']\n);\n\n// Update metrics\nplayersOnline.labels('world-1').set(150);\n"})}),"\n",(0,i.jsx)(n.h2,{id:"admin-panel-integration",children:"Admin Panel Integration"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:'Sidebar adds a "Grafana" item under the Admin Panel section.'}),"\n",(0,i.jsxs)(n.li,{children:["Opens in a new tab and honors ",(0,i.jsx)(n.code,{children:"VITE_GRAFANA_URL"})," when provided."]}),"\n",(0,i.jsxs)(n.li,{children:["Localization keys were added in ",(0,i.jsx)(n.code,{children:"en.json"}),", ",(0,i.jsx)(n.code,{children:"ko.json"}),", ",(0,i.jsx)(n.code,{children:"zh.json"})," (checked for duplicates)."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"how-to-run-localdocker",children:"How to Run (Local/Docker)"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Build the monorepo"}),"\n"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"yarn build"})," (or ",(0,i.jsx)(n.code,{children:"yarn build:backend && yarn build:frontend && yarn build:event-lens && yarn build:chat-server"}),")"]}),"\n"]}),"\n",(0,i.jsxs)(n.ol,{start:"2",children:["\n",(0,i.jsx)(n.li,{children:"Development stack"}),"\n"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"yarn docker:dev"})," to start all dev services (including Prometheus and Grafana)"]}),"\n",(0,i.jsxs)(n.li,{children:["Access Grafana: ",(0,i.jsx)(n.a,{href:"http://localhost:44000",children:"http://localhost:44000"})]}),"\n",(0,i.jsxs)(n.li,{children:["Access Prometheus: ",(0,i.jsx)(n.a,{href:"http://localhost:49090",children:"http://localhost:49090"})]}),"\n"]}),"\n",(0,i.jsxs)(n.ol,{start:"3",children:["\n",(0,i.jsx)(n.li,{children:"Production-like stack"}),"\n"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"yarn docker:up"})," to start services with production compose"]}),"\n",(0,i.jsxs)(n.li,{children:["Access Grafana: ",(0,i.jsx)(n.a,{href:"http://localhost:44000",children:"http://localhost:44000"})]}),"\n",(0,i.jsxs)(n.li,{children:["Access Prometheus: ",(0,i.jsx)(n.a,{href:"http://localhost:49090",children:"http://localhost:49090"})]}),"\n"]}),"\n",(0,i.jsxs)(n.ol,{start:"4",children:["\n",(0,i.jsx)(n.li,{children:"Restart policy"}),"\n"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Please use ",(0,i.jsx)(n.code,{children:"docker-compose down"})," then ",(0,i.jsx)(n.code,{children:"up"})," (do not use ",(0,i.jsx)(n.code,{children:"restart"}),"), per team rules."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"custom-metrics-guide-preview",children:"Custom Metrics Guide (Preview)"}),"\n",(0,i.jsxs)(n.p,{children:["Once ",(0,i.jsx)(n.code,{children:"prom-client"})," is enabled for Backend/Event Lens:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Counter example:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Name: ",(0,i.jsx)(n.code,{children:"http_requests_total"})]}),"\n",(0,i.jsxs)(n.li,{children:["Labels: ",(0,i.jsx)(n.code,{children:"method"}),", ",(0,i.jsx)(n.code,{children:"route"}),", ",(0,i.jsx)(n.code,{children:"status"})]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Histogram example:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Name: ",(0,i.jsx)(n.code,{children:"http_request_duration_seconds"})]}),"\n",(0,i.jsxs)(n.li,{children:["Labels: ",(0,i.jsx)(n.code,{children:"method"}),", ",(0,i.jsx)(n.code,{children:"route"}),", ",(0,i.jsx)(n.code,{children:"status"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Implementation pattern (Node.js/Express):"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Initialize metrics registry on app start when ",(0,i.jsx)(n.code,{children:"MONITORING_ENABLED=true"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Expose ",(0,i.jsx)(n.code,{children:"/metrics"})," endpoint returning ",(0,i.jsx)(n.code,{children:"text/plain; version=0.0.4"}),"."]}),"\n",(0,i.jsx)(n.li,{children:"Avoid side effects at import time; initialize explicitly inside a bootstrap function."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"security-notes",children:"Security Notes"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Default Grafana admin credentials are ",(0,i.jsx)(n.code,{children:"admin/admin"}),". Change them via env vars in production."]}),"\n",(0,i.jsx)(n.li,{children:"Prometheus UI should be internal-only in production or protected via reverse proxy."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,i.jsx)(n.h3,{id:"prometheus-targets",children:"Prometheus Targets"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Prometheus has a ",(0,i.jsx)(n.code,{children:"Targets"})," page to verify discovered endpoints."]}),"\n",(0,i.jsx)(n.li,{children:"If targets are missing, check the Backend HTTP-SD endpoint and service discovery configuration."}),"\n",(0,i.jsx)(n.li,{children:"Ensure ports do not conflict (Prometheus uses 49090/9090)."}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"host-based-game-server-metrics-docker-environment",children:"Host-Based Game Server Metrics (Docker Environment)"}),"\n",(0,i.jsx)(n.p,{children:"When Prometheus runs in Docker but game servers run on the host (via PM2), Prometheus cannot access host IPs directly."}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Solution"}),": The Backend automatically converts host IPs to ",(0,i.jsx)(n.code,{children:"host.docker.internal"})," for Prometheus targeting."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"How it works:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["The Backend's ",(0,i.jsx)(n.code,{children:"/api/v1/public/monitoring/prometheus/targets"})," endpoint checks if game server IPs are Docker internal (172.x.x.x) or host machine IPs."]}),"\n",(0,i.jsxs)(n.li,{children:["For host machine IPs, it automatically converts them to ",(0,i.jsx)(n.code,{children:"host.docker.internal"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Environment Variable:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"PROMETHEUS_IN_DOCKER"})," (default: ",(0,i.jsx)(n.code,{children:"true"}),"): Controls whether host IPs should be converted to ",(0,i.jsx)(n.code,{children:"host.docker.internal"}),".","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"true"})," (default): Prometheus runs in Docker, convert host IPs to ",(0,i.jsx)(n.code,{children:"host.docker.internal"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"false"}),": Prometheus runs externally (e.g., on host or separate machine), use actual IP addresses"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Docker Configuration:"}),"\nAdd to ",(0,i.jsx)(n.code,{children:"docker-compose.yml"})," (prometheus service):"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"extra_hosts:\n  - 'host.docker.internal:host-gateway'\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsxs)(n.strong,{children:["When to set ",(0,i.jsx)(n.code,{children:"PROMETHEUS_IN_DOCKER=false"}),":"]})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Prometheus runs directly on host machine (not in Docker)"}),"\n",(0,i.jsx)(n.li,{children:"Prometheus runs on a separate monitoring server"}),"\n",(0,i.jsx)(n.li,{children:"Using Kubernetes with proper network policies"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"grafana-logs-dashboard-not-showing-all-log-levels",children:"Grafana Logs Dashboard Not Showing All Log Levels"}),"\n",(0,i.jsxs)(n.p,{children:["If the Grafana Logs dashboard only shows ",(0,i.jsx)(n.code,{children:"info"})," logs even when ",(0,i.jsx)(n.code,{children:"level=All"})," is selected:"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Root Cause"}),": Loki requires labels in stream selectors to ",(0,i.jsx)(n.strong,{children:"exist"})," on log lines. If ",(0,i.jsx)(n.code,{children:"externalIp"})," or ",(0,i.jsx)(n.code,{children:"internalIp"})," labels are missing from some logs (e.g., error logs), those logs are filtered out."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Solution"}),":"]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Move optional labels (",(0,i.jsx)(n.code,{children:"internalIp"}),", ",(0,i.jsx)(n.code,{children:"externalIp"}),") from ",(0,i.jsx)(n.strong,{children:"stream selector"})," to ",(0,i.jsx)(n.strong,{children:"log pipeline filter"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Before: ",(0,i.jsx)(n.code,{children:'{job="gatrix", level=~"$level", internalIp=~"...", externalIp=~"..."}'})]}),"\n",(0,i.jsxs)(n.li,{children:["After: ",(0,i.jsx)(n.code,{children:'{job="gatrix", level=~"$level"} | json | internalIp=~"..." | externalIp=~"..."'})]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Add ",(0,i.jsx)(n.code,{children:'allValue: ".*"'})," to all multi-select variables in the dashboard JSON:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "name": "service",\n  "includeAll": true,\n  "allValue": ".*",\n  "multi": true\n}\n'})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Restart Grafana: ",(0,i.jsx)(n.code,{children:"docker restart gatrix-grafana-dev"})]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"internationalization",children:"Internationalization"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"All UI labels for the Grafana menu item are localized (ko/en/zh)."}),"\n",(0,i.jsx)(n.li,{children:'When adding new guidance strings, ensure localization keys are unique and friendly (Korean guidelines ending with "...?\ufffd\ub2c8??").'}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"loki-direct-log-push-sdk",children:"Loki Direct Log Push (SDK)"}),"\n",(0,i.jsxs)(n.p,{children:["Game servers and services now push logs directly to Loki using the ",(0,i.jsx)(n.code,{children:"@gatrix/server-sdk"}),". This modern approach replaces file-based scraping (Promtail), providing better performance, structured data, and simplified deployment."]}),"\n",(0,i.jsx)(n.h3,{id:"how-it-works",children:"How it Works"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"SDK Logger"}),": The SDK includes a ",(0,i.jsx)(n.code,{children:"LokiTransport"})," that batches log entries and sends them via HTTP POST to the Loki push API."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"SDK Manager Integration"}),": The ",(0,i.jsx)(n.code,{children:"gatrixSdkManager.ts"})," initializes the SDK with Loki settings from ",(0,i.jsx)(n.code,{children:"mconf"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"mlog Hooking"}),": After SDK initialization, the SDK's logger is injected into the game's global ",(0,i.jsx)(n.code,{children:"mlog"})," instance. All logs sent through ",(0,i.jsx)(n.code,{children:"mlog"})," (info, error, etc.) are automatically forwarded to Loki."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Automatic Labeling"}),": Logs are automatically tagged with metadata: ",(0,i.jsx)(n.code,{children:"service"}),", ",(0,i.jsx)(n.code,{children:"group"}),", ",(0,i.jsx)(n.code,{children:"environment"}),", ",(0,i.jsx)(n.code,{children:"application"}),", and ",(0,i.jsx)(n.code,{children:"hostname"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"configuration",children:"Configuration"}),"\n",(0,i.jsxs)(n.p,{children:["Loki can be enabled and configured in ",(0,i.jsx)(n.code,{children:"mconf.ts"})," or via ",(0,i.jsx)(n.code,{children:"default.json5"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json5",children:'gatrix: {\n  loki: {\n    /** Enable/disable direct Loki logging */\n    enabled: true,\n    /** Loki push API URL */\n    url: "http://localhost:43100/loki/api/v1/push",\n    /** Optional additional labels */\n    labels: {\n      source_category: "game-server"\n    },\n    /** Maximum number of log entries per batch (default: 1000) */\n    batchSize: 1000,\n    /** Maximum interval between batches in ms (default: 5000) */\n    batchInterval: 5000\n  }\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"environment-variables-1",children:"Environment Variables"}),"\n",(0,i.jsxs)(n.p,{children:["While configuration via ",(0,i.jsx)(n.code,{children:"mconf"})," is preferred, the SDK also supports automatic activation via environment variables for non-game services:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"GATRIX_LOKI_ENABLED"}),": Set to ",(0,i.jsx)(n.code,{children:"true"})," to enable."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"GATRIX_LOKI_URL"}),": Loki push endpoint."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"migration-from-promtail",children:"Migration from Promtail"}),"\n",(0,i.jsxs)(n.p,{children:["Promtail is no longer required for game server log collection. All relevant ",(0,i.jsx)(n.code,{children:"docker-compose"})," services and documentation have been updated to reflect this change. Host-based PM2 logs are now natively pushed by the application process itself."]})]})}function h(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}},8453(e,n,r){r.d(n,{R:()=>o,x:()=>t});var s=r(6540);const i={},l=s.createContext(i);function o(e){const n=s.useContext(l);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),s.createElement(l.Provider,{value:n},e.children)}}}]);