grafana:
  image: grafana/grafana:latest
  container_name: gatrix-grafana-dev
  restart: unless-stopped
  user: '0' # Run as root to avoid volume permission issues
  environment:
    GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
    GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
    GF_USERS_ALLOW_SIGN_UP: 'false'
    GF_SERVER_ROOT_URL: ${GRAFANA_ROOT_URL:-http://localhost:${FRONTEND_PORT:-43000}/grafana/}
    GF_SERVER_SERVE_FROM_SUB_PATH: 'true'
    GF_AUTH_ANONYMOUS_ENABLED: 'true'
    GF_AUTH_ANONYMOUS_ORG_ROLE: 'Admin'
    # Allow embedding and relax CSRF for local development
    GF_SECURITY_ALLOW_EMBEDDING: 'true'
    GF_SECURITY_CSRF_ALWAYS_CHECK: 'false'
    GF_SECURITY_CSRF_TRUSTED_ORIGINS: 'http://localhost:3000,http://localhost:43000,http://127.0.0.1:3000,http://127.0.0.1:43000'
    GF_SECURITY_COOKIE_SAMESITE: 'disabled'
    # Allow Live WebSockets from any origin during development
    GF_LIVE_ALLOWED_ORIGINS: '*'
  ports:
    - '0.0.0.0:${GRAFANA_PORT:-44000}:3000'
  volumes:
    - ${DATA_ROOT:-./data}/grafana:/var/lib/grafana
    - ./docker/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
    - ./docker/grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
    - ./docker/grafana/dashboards:/var/lib/grafana/dashboards:ro
  depends_on:
    prometheus:
      condition: service_started
  networks:
    - gatrix-dev-network
